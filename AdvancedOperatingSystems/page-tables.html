<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Page Tables - Knowledge Base</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Knowledge Base</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="page-tables"><a class="header" href="#page-tables">Page Tables</a></h1>
<p>OS provides virtual memory addresses to processes. Page tables store the translation from virtual addresses to physical addresses and OS gets to decide on this mapping. Virtual addresses are the index to a page table entry in the page table where physical addresses of underlying data are stored. A special register <code>cr3</code> contains physical pointer to first page table. Each page defines an address space which is useful for separating memory for separate processes.</p>
<h3 id="address-spaces"><a class="header" href="#address-spaces">Address spaces</a></h3>
<ul>
<li>Virtualize physical memory can be reused every time</li>
<li>Flexible memory management for continuous memory for example</li>
<li>Provides isolation and separation for separate processes.
<ul>
<li>Shared memory can include same virtual memory for multiple process</li>
<li>threads use shared memory</li>
<li>1 process per 1 page table is typical</li>
<li>Many processes per 1 page table is shared memory</li>
<li>Dynamically linked libraries are loaded into phys mem once</li>
</ul>
</li>
</ul>
<h3 id="linear-page-table"><a class="header" href="#linear-page-table">Linear page table</a></h3>
<ul>
<li>Simple and old design</li>
<li>first 4 bits of Virtual address are index to array of physical offsets</li>
<li>remaining 12 bits are offset within page</li>
<li>1 bit for whether the memory is present or not</li>
</ul>
<h3 id="hierarchical-page-table"><a class="header" href="#hierarchical-page-table">Hierarchical page table</a></h3>
<ul>
<li>first 10 bits are index to level 1 page table containing address of 2nd physical page table</li>
<li>second 10 bits are index to level 2 page table</li>
<li>remaining 12 bits are offset within page</li>
</ul>
<h3 id="inverted-page-tables"><a class="header" href="#inverted-page-tables">Inverted Page tables</a></h3>
<ul>
<li>IA64 (itanic)</li>
<li>using a hash of the virtual memory to store physical address, scales well</li>
</ul>
<h3 id="four-level-page-table"><a class="header" href="#four-level-page-table">Four-level Page Table</a></h3>
<ul>
<li>cr3 contains pointer to PML4 table which is highest level table</li>
<li>Highest bytes on intel aren't used by default Memory Tagging possible, set by sign extended</li>
<li>Virtual address contains:
<ul>
<li>First 16 bits are sign extend or MT Tagging</li>
<li>First 9 bits: PML4 offset</li>
<li>Second 9 bits: Page Directory-Pointer Offset</li>
<li>Third 9 bits: Page Directory Offset</li>
<li>Fourth 9 bits: Page Table Offset</li>
<li>Last 12 bits: Physical Page Offset</li>
</ul>
</li>
</ul>
<h2 id="page-table-entries"><a class="header" href="#page-table-entries">Page Table Entries</a></h2>
<ul>
<li>64 bits, contain bits for if present, writable, supervisor mode, etc...</li>
<li>48bit virtual address and physical address space</li>
<li>Address of large pages:
<ul>
<li>first level PTE doesn't support (512GB) pages</li>
<li>second level PTE supports 1GB Pages</li>
<li>third level PTE supports 2MB Pages</li>
<li>4th PTE only 4K Pages</li>
</ul>
</li>
</ul>
<h2 id="on-boot"><a class="header" href="#on-boot">On Boot</a></h2>
<ul>
<li>asm code loads addresses of the 4 levels depending on how much static memory kernel requires</li>
<li>only static</li>
</ul>
<h2 id="post-boot"><a class="header" href="#post-boot">Post Boot</a></h2>
<ul>
<li>Dynamic, allows page table mappings to change during runtime</li>
<li>Map more pages if more memory is needed</li>
<li>Unmap pages if memory is not needed</li>
<li>What should virtual address space look like in terms of policies?</li>
<li>How are they enforced?</li>
</ul>
<h2 id="virtual-address-space-of-process-p"><a class="header" href="#virtual-address-space-of-process-p">Virtual address space of process P</a></h2>
<ul>
<li>How can we ensure address space of P and P+1 are separate -&gt; page tables</li>
</ul>
<h2 id="meltdown"><a class="header" href="#meltdown">Meltdown</a></h2>
<ul>
<li>Kernel is mapped into higher regions of address space for P, how to make sure P can't access/modify Kernel data?
<ul>
<li>User supervisor bit can be set in PTE, process can't access kernel data despite it being mapped in</li>
<li>Post 2018 Meltdown was able to read kernel data, kernel no longer mapped in address space
<ul>
<li>Kernel now has own page table</li>
<li>on every syscall or Process switch, page tables must be changed, performance impact</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="foreshadow-attack"><a class="header" href="#foreshadow-attack">Foreshadow Attack</a></h2>
<ul>
<li>bypasses the present bit of a PTE, could read pages even if not present</li>
<li>Now we must clear page frame address when un-mapping</li>
</ul>
<h2 id="ridl"><a class="header" href="#ridl">RIDL</a></h2>
<ul>
<li>bypass the address bits - able to read other data</li>
<li>must flush CPU registers to solve</li>
</ul>
<h1 id="page-table-walk"><a class="header" href="#page-table-walk">Page Table Walk</a></h1>
<ul>
<li>Dynamically update page tables for each address space</li>
<li>If a process maps/un-maps in memory, it must be added/removed to address space</li>
<li>MMU uses updated page tables</li>
<li>find page table entry (assume x86_64, 48bit virt addr, page table mapped into virtual memory)</li>
</ul>
<ol>
<li>locate top-level PT (read cr3 register or process struct)</li>
<li>Locate 2nd level PT
<ul>
<li>get virtual pointer to top-level page</li>
<li>use bits 39-47 of virtual address as index</li>
<li>Is the page table entry present? if no, then abort</li>
</ul>
</li>
<li>Locate 3rd level PT
<ul>
<li>get virtual pointer to 2nd level page</li>
<li>use bits 30-38 of virtual address as index</li>
<li>is page table entry present? if no, then abort</li>
</ul>
</li>
<li>...</li>
<li>Last page table entry has physical address of page</li>
</ol>
<h3 id="instructions-to-perform-the-walk-todo"><a class="header" href="#instructions-to-perform-the-walk-todo">Instructions to perform the walk TODO</a></h3>
<ol>
<li>take 9 bits of virt addr, multiply by 8 to get offset and concatenate to bottom 12 bits of cr3.pml4</li>
<li>repeat</li>
</ol>
<h2 id="page-table-mapping"><a class="header" href="#page-table-mapping">Page Table Mapping</a></h2>
<ul>
<li>Input is Virtual address where mapping will take place, do the page table walk to find locate the page table entry</li>
<li>If entry not present at any level, allocate new page, store its physical address in non-present entry, continue with next level</li>
<li>Finally store physical address of page to be mapped in final PTE</li>
</ul>
<h2 id="page-table-unmapping"><a class="header" href="#page-table-unmapping">Page Table Unmapping</a></h2>
<ul>
<li>Locate PTE from virt addr to be unmapped with page table walk</li>
<li>zero out final table entry (Because of Foreshadow attack)</li>
<li>Free the page table (optional)</li>
<li>free the page</li>
</ul>
<h2 id="permission-bits"><a class="header" href="#permission-bits">Permission bits</a></h2>
<ul>
<li>P: page faults (0) or present (1)</li>
<li>R/W: read-only (0) or writable (1)</li>
<li>U/S: Supervisor-only (0) or user-accessible (1)
<ul>
<li>SMAP protection: 1 becomes user-only (follow POLP)</li>
</ul>
</li>
<li>XD: execute allowed (0) or disabled (1)</li>
</ul>
<h2 id="translation-lookaside-buffer-tlb"><a class="header" href="#translation-lookaside-buffer-tlb">Translation Lookaside Buffer (TLB)</a></h2>
<ul>
<li>result of PT translation is a mapping, so we cache the mapping</li>
<li>Hardware based cache that stores memory addresses</li>
<li>Temporal and spatial locality</li>
<li>TLB has very small size, due to implementing LRU</li>
<li>thus, bad temporal and spatial locality will reduce performance</li>
<li>Since TLB is a cache of the page tables, it must be flushed when the Page tables are changed (switching to a new address space) and when explicitly flushing</li>
<li>If TLB not flushed when necessary means disaster</li>
<li>Translation Caches
<ul>
<li>caching PT pages</li>
<li>OS can use bigger pages -&gt; shorter walk on TLB Miss</li>
<li>translation cache tagged with part of virt addr
<ul>
<li>reduce time it takes for a TLB miss</li>
<li>managed transparently by hardware</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<ul>
<li>Use page tables to improve sanity checks leave holes and let CPU raise segmentation fault</li>
<li>holes in the identity map, just before and after array add guard page</li>
<li>Pros: no wastage</li>
<li>Cons: more complex management</li>
</ul>
<h3 id="exploits"><a class="header" href="#exploits">Exploits</a></h3>
<ul>
<li>kernels are Highly complex concurrent code (~20M lines of  code)</li>
<li>Physmap in linux is a primary target</li>
<li>kernel base address is a jump target</li>
</ul>
<h3 id="kernel-address-space-layout-randomization-kaslr"><a class="header" href="#kernel-address-space-layout-randomization-kaslr">Kernel Address Space Layout Randomization (KASLR)</a></h3>
<ul>
<li>Randomizes sections in kernel address space</li>
<li>The entire kernel code starts from a random address space
<ul>
<li>brute-forcing leads to crashes</li>
<li>leak kernel pointers, requires second vulnerability</li>
<li>side-channel attacks, very complex to defend</li>
</ul>
</li>
<li>entropy simplified, remains the same until reboot</li>
<li>random slot is chosen early during boot, kernel is mapped there</li>
<li>requires remapping kernel itself as well as its physical memory</li>
<li>use side channels to leak a kernel address</li>
</ul>
<h1 id="questions"><a class="header" href="#questions">Questions</a></h1>
<ul>
<li>What is in the address field of a PTE?
<ul>
<li>there is a fraction of a physical address along with the page table offset</li>
</ul>
</li>
<li>How much memory can be mapped in x86_64?
<ul>
<li>48 bits to store physical address = 2^40 * 2^8 = 256 Tb</li>
</ul>
</li>
<li>How much memory does a Page in the Page table map?
<ul>
<li>depends whether it is used for large pages, huge or normal pages, but each PTP is 4KB and each PTE is 8 bytes 4096/8 = 512 or 2^12 / 2^3 = 2^9</li>
</ul>
</li>
<li>How to find page table pages?
<ul>
<li>Go through levels of page tables to find entry we want to change.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../AdvancedOperatingSystems/memory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../AdvancedOperatingSystems/user-mode.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../AdvancedOperatingSystems/memory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../AdvancedOperatingSystems/user-mode.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
