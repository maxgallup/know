<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Memory - Knowledge Base</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Knowledge Base</a></li><li class="chapter-item expanded "><a href="../software-testing/index.html"><strong aria-hidden="true">2.</strong> Software Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../software-testing/srs.html"><strong aria-hidden="true">2.1.</strong> Software Requirements Specification</a></li><li class="chapter-item expanded "><a href="../software-testing/white-box.html"><strong aria-hidden="true">2.2.</strong> White Box Testing</a></li><li class="chapter-item expanded "><a href="../software-testing/black-box.html"><strong aria-hidden="true">2.3.</strong> Black Box Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced-os/index.html"><strong aria-hidden="true">3.</strong> Advanced Operating Systems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced-os/booting.html"><strong aria-hidden="true">3.1.</strong> Booting</a></li><li class="chapter-item expanded "><a href="../advanced-os/memory.html" class="active"><strong aria-hidden="true">3.2.</strong> Memory</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Knowledge Base</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="physical-memory"><a class="header" href="#physical-memory">Physical Memory</a></h1>
<p>The memory controller communicates on the BUS over different channels (usually 1 / 2), but only one <strong>channel</strong> can be active at a time. For each channel there are physical memory modules (<a href="https://en.wikipedia.org/wiki/DIMM">DIMMs</a>). One side of the <strong>DIMM</strong> is a <strong>rank</strong>, typically 1/2 ranks per DIMM. Each rank has a <strong>chip</strong>, with a number of <strong>rows and columns</strong>.</p>
<p>Linux organizes memory into consecutive page frames and grouped together in the following way:</p>
<ul>
<li>Nodes - <a href="https://en.wikipedia.org/wiki/Non-uniform_memory_access">NUMA</a> abstraction for N "banks"</li>
<li>Zones - tagged regions within each node</li>
<li>Pages - Physical page frames from each zone</li>
</ul>
<p>Linux Zone ranges:</p>
<ul>
<li>ZONE_DMA: 0 - 16MB <em>for legacy hardware</em></li>
<li>ZONE_DMA32: 16MB - 4GB <em>for legacy hardware</em></li>
<li>ZONE_NORMAL: 16MB - 896MB <em>for kernel - always mapped</em></li>
<li>ZONE_HIGHMEM: 896MB - END <em>used for kmap, on demand memory mapping x86</em></li>
</ul>
<p>Zones are managed independently, however boundaries become blurry when under pressure. Kernel daemon kswapd will reclaim memory when certain thresholds are crossed. Virtual memory mapping on x86-32 starts ZONE_DMA and ZONE_NORMAL directly after the PAGE_OFFSET and ZONE_HIGHMEM is mapped on demand. The PAGE_OFFSET is where the user space processes start. However, for x86-64 there are 47 bits of memory address space available, so it can simply map all zones into one continuous region.</p>
<h2 id="pages"><a class="header" href="#pages">Pages</a></h2>
<ul>
<li>4KB of physical memory</li>
<li><code>linux/mmzone.h</code> has mem_map array which holds page objects</li>
</ul>
<h1 id="allocators"><a class="header" href="#allocators">Allocators</a></h1>
<p>Linux has one main page allocator (Buddy allocator) which allocates contiguous areas of physical memory. All allocators custom to the kernel from different subsystems interact with it. The Memblock allocator is an early boot-time allocator, discarded after initialization and contains two simple data structures: all present memory and allocated memory regions. Memblock has the following procedures:</p>
<p>Setup: add all available physical memory regions, add reserved to reserved list, sort by base address
Allocation: first fit memory, add to reserved list and merge neighbors if possible
De-allocation: scans reserved list, split up regions if necessary</p>
<h2 id="memblock-boot-allocator"><a class="header" href="#memblock-boot-allocator">Memblock Boot Allocator</a></h2>
<p>Can only allocate memory and maintains an index to the next free block. It's essentially just one long array of bytes.</p>
<h2 id="buddy-allocator"><a class="header" href="#buddy-allocator">Buddy Allocator</a></h2>
<p>Power of two allocator with free coalescing. During allocation, requested size will go into a block that satisfies the size, unused remainders are inevitable. During de-allocation, neighboring buddy block is checked and coalesced if it is free (recursively). MAX_ORDER in linux specifies a power of two coefficient for the maximum number of orders (levels). Works at a per-zone separation.</p>
<h1 id="vmalloc-vs-slab-allocator"><a class="header" href="#vmalloc-vs-slab-allocator">vmalloc vs slab allocator</a></h1>
<ul>
<li>vmalloc
<ul>
<li>plugs in small holes and prevents external fragmentation</li>
<li>is better for very large allocations, since buddy/slab will then cause more external fragmentation</li>
<li>is slower than slab</li>
<li>uses non-contiguous physical memory</li>
<li>has its own range</li>
</ul>
</li>
<li>slab allocator
<ul>
<li>is very fast, since it uses a cache</li>
<li>uses contiguous physical memory</li>
</ul>
</li>
</ul>
<h3 id="fragmentation"><a class="header" href="#fragmentation">Fragmentation</a></h3>
<ul>
<li><strong>External fragmentation</strong> When a request for a large amount of memory comes in, although there might be enough memory for it, it is unable to be allocated due to many disjoint holes of unallocated space.
<ul>
<li>Solved by the <code>vmalloc</code> allocator which sits on top of buddy allocator for large allocations, uses first-fit technique and maps page frames in virtually continuous buffer to scattered pages across physical memory. Allocates a single page from the buddy allocator at a time.</li>
</ul>
</li>
<li><strong>Internal fragmentation</strong> Allocations smaller than 4Kb will always have wasted space, as well as when requests are just above the closest power of two.
<ul>
<li>Addressed with the <code>slab</code> allocator which also sits on top of buddy allocator. For small allocations, continuous in virtual memory as well as physical memory</li>
</ul>
</li>
</ul>
<h3 id="sanity-checks-during-development"><a class="header" href="#sanity-checks-during-development">Sanity Checks during development</a></h3>
<ul>
<li><code>CONFIG_DEBUG_PAGEALLOC</code>
<ol>
<li>Out of bounds detection, adds page guards before and after page which limits how far out of bounds accesses can go. Page canaries will be changed if magic value is changed are also possible.</li>
<li>Use after free detection (<code>kernel_map_pages</code>) simply unmaps virtual memory interrupt handled by MMU, accept for when it is reused again. Can also use page poisoning which lets us lazily detect write-after-frees, however also after page is reused, no longer protected</li>
<li><code>kmemcheck</code> - traps at every read to check if data is initialized, very expensive</li>
<li><code>kmemleak</code> - periodic garbage collection, reports about unlinked objects, false positives can happen</li>
<li><code>kasan</code> - compiler instrumentation, adds combines canary and poison ideas</li>
</ol>
</li>
<li>out of bounds detection only works for off-by-one errors, page-guard vs poison strategy performance difference is non-trivial, but generally page-guards are faster</li>
</ul>
<h1 id="questions-and-answers"><a class="header" href="#questions-and-answers">Questions and Answers</a></h1>
<ul>
<li>
<p>Holes in physical memory are either device mapped or reserved, what reserves them?</p>
<ul>
<li>BIOS reserves memory as well</li>
</ul>
</li>
<li>
<p>might the BIOS reserve memory regions? some holes backed by memory. Some should escape memory management logic</p>
</li>
<li>
<p>Why does the kernel have to use virtual memory addresses in the first place can't it just map directly?</p>
<ul>
<li>needs to provide memory separation for clients</li>
</ul>
</li>
<li>
<p>Padding added to zone struct caching?</p>
<ul>
<li>Cache sharing issues for multicore processors. Ping Pong effect can happen.</li>
</ul>
</li>
<li>
<p>Why do we need zones? - tag memory to differentiate for different purposes surface access only software cares about it, but devices might have hardware limitations.</p>
</li>
<li>
<p>Why do we need  pages? - since hardware provided page granularity</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../advanced-os/booting.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../advanced-os/booting.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
